# 第二次作业《光栅化算法的实现》项目报告

**项目名称:** ShapePainter v4.1 - 高性能光栅化引擎

**核心目标:** 在第一次作业的基础上，从零开始构建一套完整的底层光栅化渲染引擎，替换掉第一次作业中对`PyQt`原生绘图API的直接调用，从而深入理解图形学核心算法的实现原理与性能优化。

---

### 一、 对比第一次作业：核心功能新增与修改总览

相较于第一次作业，本次项目进行了脱胎换骨的重构与升级。核心修改可以总结为：我们**“造”了一个全新的渲染引擎**来替换掉原来直接“买”来的引擎。

| 功能模块 | 第一次作业 (旧版) | 第二次作业 (新版) - **主要修改与新增** |
| :--- | :--- | :--- |
| **渲染核心** | 直接调用`QPainter`的`draw...`系列函数进行绘制。 | **【新增】完全自研的渲染管线 (`renderer.py`)**，通过逐像素操作`QImage`帧缓冲来绘制，`QPainter`只在最后一步用于“上屏”。 |
| **算法实现** | 无，所有算法都封装在`QPainter`黑盒中。 | **【新增】完整的底层算法库 (`raster_algorithms.py`)**，从零实现了Bresenham、DDA、中点画圆/椭圆、扫描线填充、**贝塞尔曲线扁平化**等一系列核心算法。 |
| **性能与刷新机制** | 每次操作都全局重绘，图形多时性能下降并可能闪烁。 | **【新增】高性能渲染架构**：引入**图层缓存**和**脏标记 (Dirty Flag)**机制，实现了增量式刷新，彻底解决了闪烁问题，保证了高帧率下的流畅交互。 |
| **抗锯齿 (反走样)** | 依赖`QPainter`的默认抗锯齿。 | **【新增】独立的超采样抗锯齿 (SSAA) 功能**，可通过“视图”菜单动态开关，为我们自己的算法提供高质量的平滑边缘效果。 |
| **对比功能** | 无。 | **【新增】“双引擎”一键切换系统**：在UI工具栏上增加了“直线算法”下拉菜单，允许在自研算法 ("Bresenham", "DDA") 和原生引擎 ("PyQt原生") 之间实时切换，以直观对比效果。 |
| **填充样式** | 支持`PyQt`提供的所有填充样式。 | **【新增】智能UI**：填充样式下拉菜单会根据当前渲染引擎动态更新。在自研引擎下，明确提示用户仅支持“纯色”填充，避免了功能与表现不一致的问题。 |
| **命令系统 (`commands.py`)** | `Command`仅负责修改数据。 | **【修改】`Command`系统与渲染器联动**：所有修改图形外观的命令，现在都会在执行后主动将被影响图层的`is_dirty`标记设为`True`，以驱动缓存系统进行更新。 |
| **数据模型 (`shapes.py`)** | `Layer`类是简单的图形容器。 | **【修改】`Layer`类增加`cache`和`is_dirty`属性**，并为所有`Shape`增加了对`Layer`的反向引用，为高性能缓存架构提供了数据层支持。 |
| **用户手册** | 版本陈旧，功能描述不全。 | **【修改】全面更新了用户手册**，详细介绍了包括双引擎切换、SSAA抗锯齿、图层混合模式、高级节点编辑等所有新功能，与当前项目完全匹配。 |

---

### 二、 严格对照作业要求：完成情况清单

- **[✔] 使用至少两种光栅化算法:** 我们实现了 **Bresenham、DDA、中点画圆、中点画椭圆** 等多种算法，远超要求。
- **[✔] 使用扫描线填充算法:** 我们实现了健壮的 `scanline_fill_polygon` 算法，并将其成功应用于**矩形、多边形、椭圆和圆角矩形**的填充。
- **[✔] 实现缩放、平移、旋转等功能:** 所有变换功能均已实现，且支持多选对象同时变换。
- **[✔] 减少操作时的闪烁现象:** 通过引入**帧缓冲 (Framebuffer) 和图层缓存 (Layer Caching) 架构**，我们从根本上杜绝了闪烁，实现了专业级的流畅交互。
- **[✔] 实现反走样处理:** 我们实现了效果出色的 **2x 超采样抗锯齿 (SSAA)**，并为其提供了动态开关。
- **[✔] 与第一次作业成果集成对比:** 我们在UI上提供了**“直线算法”下拉菜单**，实现了自研引擎与原生引擎的一键切换对比，完美达成此项要求。
- **[✔] 不可直接调用现成的库函数:** 我们的自定义渲染管线严格遵守此规定，最终通过 `setPixelColor` 逐像素绘制，所有核心图形算法均为自主实现。
- **[✔] 人机交互友好、功能完整、系统有特色、有亮点:**
  - **交互友好:** 动态UI提示、完整的Undo/Redo、标尺参考线、对齐工具等都极大地提升了用户体验。
  - **功能完整:** 项目具备了图层、混合模式、SVG导出、偏好设置等一系列实用功能，已成为一个相当完善的绘图工具。
  - **特色与亮点:**
    1. **双引擎切换对比系统** 是最大的特色。
    2. **高性能缓存渲染架构** 是技术上最大的亮点。
    3. **从零实现包括贝塞尔曲线在内的全套光栅化算法** 是算法层面最大的亮点。

---

### 三、 总结

第二次作业的核心任务是“**从无到有，再到优秀**”。我们不仅成功地从零构建了一套功能完整的底层光栅化渲染引擎，还为其配备了通常只有在成熟软件中才能见到的高性能缓存架构和高质量抗锯齿技术。通过智能化的UI设计，我们还完美地将新旧两个引擎融合在一个平台中，用于直观的教学对比。